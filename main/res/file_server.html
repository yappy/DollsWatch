<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>File Server</title>
</head>

<body>
  <h1>File Server</h1>

  <div><input id="upload_file" type="file" /></div>
  <div><input id="upload_button" type="button" value="upload" /></div>
  <div><progress id="upload_prog" max="100" value="0" /></div>
  <div><p id="upload_msg"></p></div>

  <hr>

  <div id="list_status">File List Status</div>
  <ul id="file_list">
  </ul>

<script>
var update_list = function() {
  var status = document.getElementById("list_status");
  var ul = document.getElementById("file_list");

  var xhr = new XMLHttpRequest();
  xhr.open('GET', './recovery/file', true);
  xhr.setRequestHeader('FILE-CMD', "LIST");
  xhr.onreadystatechange = function () {
    if(xhr.readyState == 4) {
      if (xhr.status === 200) {
        // parse json
        var list = JSON.parse(xhr.responseText);
        // remove all
        while (ul.firstChild) {
          ul.removeChild(ul.firstChild);
        }
        // add list element
        list.forEach(function(path) {
          var li = document.createElement("li");
          var del_button = document.createElement("input");
          del_button.type = "button";
          del_button.value = "Delete";
          del_button.onclick = function() {
            del_file(path);
          };
          li.appendChild(del_button);
          li.appendChild(document.createTextNode(path));
          ul.appendChild(li);
        });
        status.innerText = "Files: " + list.length;
      }
      else {
        status.innerText = "error: " + xhr.statusText;
      }
    }
  };
  status.innerText = "Updating file list...";
  xhr.send();
};

var post_file = function(upload_file) {
  var content_type = upload_file.type;
  content_type = (content_type == "") ?
    "application/octet-stream" : content_type;
  var file_name = upload_file.name;
  var msg = document.getElementById("upload_msg");

  var xhr = new XMLHttpRequest();
  xhr.open('POST', './recovery/file', true);
  xhr.setRequestHeader('Content-type', content_type);
  xhr.setRequestHeader('FILE-PATH', file_name);

  var progress = document.getElementById("upload_prog");
  xhr.onreadystatechange = function () {
    if(xhr.readyState == 4) {
      if (xhr.status === 200) {
        msg.innerText = xhr.responseText;
        setTimeout(function() { location.reload(true); }, 1000);
      }
      else {
        msg.innerText = "error: " + xhr.statusText;
      }
    }
  };
  xhr.upload.onprogress = function(e) {
    if (e.lengthComputable) {
      progress.value = (e.loaded / e.total) * 100;
    }
  };
  xhr.send(upload_file);
};

var del_file = function(delete_file) {
  // remove last "/"
  if (delete_file.endsWith("/")) {
    delete_file = delete_file.substring(0, delete_file.length - 1);
  }

  var xhr = new XMLHttpRequest();
  xhr.open('POST', './recovery/file', false);
  xhr.setRequestHeader('FILE-CMD', "DELETE");
  xhr.setRequestHeader('FILE-PATH', delete_file);
  // blocking
  xhr.send(upload_file);
  update_list();
};

document.getElementById("upload_button").addEventListener(
  "click",
  function() {
    var element_file = document.getElementById("upload_file");
    var upload_file = element_file.files[0];
    post_file(upload_file);
  },
  false);

update_list();
</script>

</body>

</html>
